{"paragraphs":[{"title":"Create DF groups by cups from SIPSCO","text":"%spark\n\n// First, import the Spark SQL types\nimport org.apache.spark.sql.DataFrame\nimport org.apache.spark.sql.functions._\n\n\n// Read tables SIPS, SIPSCo y contracts\nval sips: DataFrame = spark.table(\"SIPS\")\nval sipsCo: DataFrame = spark.table(\"SIPSCO\")\nval contracts: DataFrame = spark.table(\"contracts\")\n\n// Obtain the latest consumption by CUPS in SIPSCo\nval lastConsumptionWithFfin = sipsCo.groupBy(\"cups\").agg(max(\"ffin\")as \"ffin\")","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.apache.spark.sql.DataFrame\nimport org.apache.spark.sql.functions._\nsips: org.apache.spark.sql.DataFrame = [cups: string, distribuidora: string ... 16 more fields]\nsipsCo: org.apache.spark.sql.DataFrame = [cups: string, finicio: date ... 22 more fields]\ncontracts: org.apache.spark.sql.DataFrame = [fcontrato: string, numcontrato: string ... 9 more fields]\nlastConsumptionWithFfin: org.apache.spark.sql.DataFrame = [cups: string, ffin: date]"}]},"apps":[],"jobName":"paragraph_1684574241669_-1855417210","id":"20230520-111721_2079885702","dateCreated":"2023-05-20T11:17:21+0200","dateStarted":"2023-05-23T08:19:18+0200","dateFinished":"2023-05-23T08:19:21+0200","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:19381"},{"title":"Adding rest of SIPSCO's fields ","text":"%spark\n// Obtain the rest of the fields of sipcCo for the rows resulting from the aggregation\nval lastConsumption = sipsCo.join(lastConsumptionWithFfin, Seq(\"cups\", \"ffin\"), \"inner\")\nlastConsumption.show(5)","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"lastConsumption: org.apache.spark.sql.DataFrame = [cups: string, ffin: date ... 22 more fields]\n+--------------------+----------+----------+------+---------------+---------------+---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+-----------------+-----------------+-----------------+--------+--------+--------+--------+--------+--------+-------+----+\n|                cups|      ffin|   finicio|tarifa|consumoactivap1|consumoactivap2|consumoactivap3|consumoactivap4|consumoactivap5|consumoactivap6|consumoreactivap1|consumoreactivap2|consumoreactivap3|consumoreactivap4|consumoreactivap5|consumoreactivap6|potmaxp1|potmaxp2|potmaxp3|potmaxp4|potmaxp5|potmaxp6|numdias| cmd|\n+--------------------+----------+----------+------+---------------+---------------+---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+-----------------+-----------------+-----------------+--------+--------+--------+--------+--------+--------+-------+----+\n|ES002200000400124...|2017-10-29|2017-09-28|   005|       501000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     31|null|\n|ES002200000400135...|2017-10-25|2017-09-25|   001|       308000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     30|null|\n|ES002200000400144...|2017-10-26|2017-09-28|   001|       159000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     28|null|\n|ES002200000400155...|2017-10-26|2017-09-28|   001|       110000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     28|null|\n|ES002200000400172...|2017-11-12|2017-10-09|   001|        87000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     34|null|\n+--------------------+----------+----------+------+---------------+---------------+---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+-----------------+-----------------+-----------------+--------+--------+--------+--------+--------+--------+-------+----+\nonly showing top 5 rows"}]},"apps":[],"jobName":"paragraph_1684595964937_218553998","id":"20230520-171924_1399195679","dateCreated":"2023-05-20T17:19:24+0200","dateStarted":"2023-05-23T08:20:12+0200","dateFinished":"2023-05-23T08:20:25+0200","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:19382"},{"title":"Adding SIPS to the DF","text":"%spark\n\n// Combine with the complete data of the last consumptions with the table of supplies\nval lastConsumptionWithSips = sips.join(lastConsumption, Seq(\"cups\"), \"inner\")\nlastConsumptionWithSips.show(5)","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","tableHide":true,"title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"lastConsumptionWithSips: org.apache.spark.sql.DataFrame = [cups: string, distribuidora: string ... 39 more fields]\n+--------------------+--------------------+-------+----------+------+---------+-----+---------+------+--------+---------+----------+----------+----------+----------+----------+----------+-----------+----------+----------+------+---------------+---------------+---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+-----------------+-----------------+-----------------+--------+--------+--------+--------+--------+--------+-------+----+\n|                cups|       distribuidora|coddist|     falta|tarifa|tensionps|fases|potmaxbie|derext|deraccll|perfilree|potcontrp1|potcontrp2|potcontrp3|potcontrp4|potcontrp5|potcontrp6|autoconsumo|      ffin|   finicio|tarifa|consumoactivap1|consumoactivap2|consumoactivap3|consumoactivap4|consumoactivap5|consumoactivap6|consumoreactivap1|consumoreactivap2|consumoreactivap3|consumoreactivap4|consumoreactivap5|consumoreactivap6|potmaxp1|potmaxp2|potmaxp3|potmaxp4|potmaxp5|potmaxp6|numdias| cmd|\n+--------------------+--------------------+-------+----------+------+---------+-----+---------+------+--------+---------+----------+----------+----------+----------+----------+----------+-----------+----------+----------+------+---------------+---------------+---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+-----------------+-----------------+-----------------+--------+--------+--------+--------+--------+--------+-------+----+\n|ES002200000400107...|UNION FENOSA DIST...|   0022|1986-12-31|   001|        1| null|     5750|  5500|    2200|       PA|       1.0|       2.0|    2200.0|      null|      null|      null|         01|2017-10-25|2017-09-25|   001|        13000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     30|null|\n|ES002200000400108...|UNION FENOSA DIST...|   0022|1986-12-31|   001|        2| null|     5750|  5500|    3300|       PA|       1.0|       2.0|    2300.0|      null|      null|      null|         01|2017-10-29|2017-09-28|   001|        97000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     31|null|\n|ES002200000400179...|UNION FENOSA DIST...|   0022|1986-12-31|   004|        2| null|     9200|  8800|    8800|       PC|       1.0|       2.0|    5750.0|    5750.0|      null|      null|         01|2017-10-25|2017-09-25|   004|        44000.0|        35000.0|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     30|null|\n|ES002200000400228...|UNION FENOSA DIST...|   0022|1986-12-31|   001|        1| null|     5750|  3300|    3300|       PA|       1.0|       2.0|    3300.0|      null|      null|      null|         01|2017-10-26|2017-09-26|   001|         8000.0|           null|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     30|null|\n|ES002200000400275...|UNION FENOSA DIST...|   0022|1986-12-31|   004|        2| null|     5750|  5500|    4600|       PC|       1.0|       4.0|    4600.0|    4600.0|      null|      null|         01|2017-10-29|2017-09-28|   004|        29000.0|        40000.0|           null|           null|           null|           null|             null|             null|             null|             null|             null|             null|    null|    null|    null|    null|    null|    null|     31|null|\n+--------------------+--------------------+-------+----------+------+---------+-----+---------+------+--------+---------+----------+----------+----------+----------+----------+----------+-----------+----------+----------+------+---------------+---------------+---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+-----------------+-----------------+-----------------+--------+--------+--------+--------+--------+--------+-------+----+\nonly showing top 5 rows"}]},"apps":[],"jobName":"paragraph_1684595864168_-907143490","id":"20230520-171744_1231979208","dateCreated":"2023-05-20T17:17:44+0200","dateStarted":"2023-05-23T08:20:27+0200","dateFinished":"2023-05-23T08:20:48+0200","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:19383"},{"title":"Adding contracts to the DF","text":"%spark\n\n// unify with contracts\nval latestConsumptionWithSipsWithContracts = contracts.join(lastConsumptionWithSips , Seq(\"CUPS\"), \"inner\")","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"latestConsumptionWithSipsWithContracts: org.apache.spark.sql.DataFrame = [cups: string, fcontrato: string ... 49 more fields]"}]},"apps":[],"jobName":"paragraph_1684595895906_-1506677412","id":"20230520-171815_862997771","dateCreated":"2023-05-20T17:18:15+0200","dateStarted":"2023-05-23T08:20:59+0200","dateFinished":"2023-05-23T08:21:00+0200","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:19384"},{"title":"Selecting columns for final DF -DA ERROR-","text":"%spark\n// Select the necessary columns for the CURRENT_CONSUMPTION table\n/*val currentConsumption = latestConsumptionWithSipsWithContracts.select(\"CUPS\", \"numcontrato\",\"fcontrato\",\"codproducto\" ,\"email\",\"codpostal\", \"distribuidora\",\"coddist\",\"falta\",\"tarifa\",\"tensionps\",\"fases\",\"potmaxbie\",\"perfilree\",\"potcontrp1\",\"potcontrp2\",\"potcontrp3\",\"potcontrp4\",\"potcontrp5\",\"potcontrp6\",\"potmaxp1\",\"potmaxp2\",\"potmaxp3\",\"potmaxp4\",\"potmaxp5\",\"potmaxp6\", \"finicio\", \"ffin\",\"consumoactivap1\",\"consumoactivap2\",\"consumoactivap3\",\"consumoactivap4\",\"consumoactivap5\",\"consumoactivap6\", \"numdias\", \"cmd\")\ncurrentConsumption.show*/","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1684595809040_-292541892","id":"20230520-171649_1893914455","dateCreated":"2023-05-20T17:16:49+0200","dateStarted":"2023-05-21T07:13:35+0200","dateFinished":"2023-05-21T07:13:36+0200","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:19385"},{"title":"Selecting columns for final DF","text":"%spark\nimport org.apache.spark.sql.functions.col\n\n// Select the necessary columns for the CURRENT_CONSUMPTION table\nval currentConsumption = latestConsumptionWithSipsWithContracts.select(\n  col(\"default.sips.tarifa\"), // Specify the table name for the 'tarifa' column\n  col(\"CUPS\"), \n  col(\"numcontrato\"), \n  col(\"fcontrato\"), \n  col(\"codproducto\"), \n  col(\"email\"), \n  col(\"codpostal\"), \n  col(\"distribuidora\"), \n  col(\"coddist\"), \n  col(\"falta\"), \n  col(\"tensionps\"), \n  col(\"fases\"), \n  col(\"potmaxbie\"), \n  col(\"perfilree\"), \n  col(\"potcontrp1\"), \n  col(\"potcontrp2\"), \n  col(\"potcontrp3\"), \n  col(\"potcontrp4\"), \n  col(\"potcontrp5\"), \n  col(\"potcontrp6\"), \n  col(\"potmaxp1\"), \n  col(\"potmaxp2\"), \n  col(\"potmaxp3\"), \n  col(\"potmaxp4\"), \n  col(\"potmaxp5\"), \n  col(\"potmaxp6\"), \n  col(\"finicio\"), \n  col(\"ffin\"), \n  col(\"consumoactivap1\"), \n  col(\"consumoactivap2\"), \n  col(\"consumoactivap3\"), \n  col(\"consumoactivap4\"), \n  col(\"consumoactivap5\"), \n  col(\"consumoactivap6\"), \n  col(\"numdias\"), \n  col(\"cmd\")\n)\n\ncurrentConsumption.show(5)\n","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.apache.spark.sql.functions.col\ncurrentConsumption: org.apache.spark.sql.DataFrame = [tarifa: string, CUPS: string ... 34 more fields]\n+------+--------------------+-----------+--------------------+--------------------+--------------------+---------+--------------------+-------+----------+---------+-----+---------+---------+----------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+--------+----------+----------+---------------+---------------+---------------+---------------+---------------+---------------+-------+----+\n|tarifa|                CUPS|numcontrato|           fcontrato|         codproducto|               email|codpostal|       distribuidora|coddist|     falta|tensionps|fases|potmaxbie|perfilree|potcontrp1|potcontrp2|potcontrp3|potcontrp4|potcontrp5|potcontrp6|potmaxp1|potmaxp2|potmaxp3|potmaxp4|potmaxp5|potmaxp6|   finicio|      ffin|consumoactivap1|consumoactivap2|consumoactivap3|consumoactivap4|consumoactivap5|consumoactivap6|numdias| cmd|\n+------+--------------------+-----------+--------------------+--------------------+--------------------+---------+--------------------+-------+----------+---------+-----+---------+---------+----------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+--------+----------+----------+---------------+---------------+---------------+---------------+---------------+---------------+-------+----+\n|   001|ES002200000400228...|   00067996|Jan 7, 2018 5:37:...|76446b8d6a56e2bac...|pedro.negron.dumm...|    13813|UNION FENOSA DIST...|   0022|1986-12-31|        1| null|     5750|       PA|       1.0|       2.0|    3300.0|      null|      null|      null|    null|    null|    null|    null|    null|    null|2017-09-26|2017-10-26|         8000.0|           null|           null|           null|           null|           null|     30|null|\n|   001|ES002200000403974...|   00678073|Jan 14, 2018 9:31...|34a54d5ec535aa040...|carlota.lovato.du...|    50524|UNION FENOSA DIST...|   0022|1987-01-27|        2| null|     5750|       PA|       1.0|       4.0|    4600.0|      null|      null|      null|    null|    null|    null|    null|    null|    null|2017-10-04|2017-11-08|       434000.0|           null|           null|           null|           null|           null|     35|null|\n|   004|ES002200000404119...|   00547151|Jan 13, 2018 8:11...|c97c93fa9a1221452...|horacio.vanegas.d...|    48435|UNION FENOSA DIST...|   0022|      null|        2| null|     9200|       PC|       1.0|       2.0|    5750.0|    5750.0|      null|      null|    null|    null|    null|    null|    null|    null|2017-09-17|2017-10-17|       124000.0|        83000.0|           null|           null|           null|           null|     30|null|\n|   001|ES002200000404356...|   00318293|Jan 18, 2018 8:31...|1b009a4526c52ac2a...|reina.garica.dumm...|    26533|UNION FENOSA DIST...|   0022|1987-02-02|        1| null|     5750|       PA|       1.0|       2.0|    1100.0|      null|      null|      null|    null|    null|    null|    null|    null|    null|2017-08-29|2017-09-27|        12000.0|           null|           null|           null|           null|           null|     29|null|\n|   001|ES002200000438791...|   00770228|Jan 12, 2018 8:14...|5b3aa04830e535dd9...|victor.zuniga.dum...|    00303|UNION FENOSA DIST...|   0022|1987-04-08|        1| null|     5750|       PA|       2.0|       1.0|    1100.0|      null|      null|      null|    null|    null|    null|    null|    null|    null|2017-09-01|2017-11-01|       140000.0|           null|           null|           null|           null|           null|     61|null|\n+------+--------------------+-----------+--------------------+--------------------+--------------------+---------+--------------------+-------+----------+---------+-----+---------+---------+----------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+--------+----------+----------+---------------+---------------+---------------+---------------+---------------+---------------+-------+----+\nonly showing top 5 rows"}]},"apps":[],"jobName":"paragraph_1684645897158_113676883","id":"20230521-071137_1950152261","dateCreated":"2023-05-21T07:11:37+0200","dateStarted":"2023-05-23T08:21:06+0200","dateFinished":"2023-05-23T08:21:25+0200","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:19386"},{"title":"Save to parquet","text":"%spark\n\ncurrentConsumption.write.mode(\"overwrite\").format(\"parquet\").save(\"/user/azahara/trusted/consumoActual\")","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1684597439572_-1999625216","id":"20230520-174359_1344972228","dateCreated":"2023-05-20T17:43:59+0200","dateStarted":"2023-05-23T08:22:57+0200","dateFinished":"2023-05-23T08:23:43+0200","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:19387"},{"text":"%spark\n","user":"anonymous","dateUpdated":"2023-05-23T08:23:47+0200","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala","tableHide":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1684822889318_489242597","id":"20230523-082129_1305827779","dateCreated":"2023-05-23T08:21:29+0200","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:19697"}],"name":"GOLD LAYER/table currentConsumption","id":"2J2ZR91P6","noteParams":{},"noteForms":{},"angularObjects":{"sh:shared_process":[],"livy:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}